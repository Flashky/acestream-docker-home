<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Ace Link</title>
    <link rel="icon" type="image/x-icon"
          href="./favicon.ico"/>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet"/>
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/showdown@1.9.1/dist/showdown.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.0/dist/purify.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
    <link rel="stylesheet" type="text/css" href="./styles.css" as="style">
</head>
<body>
<div id="toggle-view">
    <i class="fas fa-eye-slash" id="toggle-icon"></i>
</div>
<video id="video" class="video-js vjs-default-skin" controls preload="auto" data-setup="{}" width="100%" height="100%">
    <p class="vjs-no-js"> To view this video please enable JavaScript, and consider upgrading to a web browser that
        <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
    </p>
</video>
<div id="acestream-link">
    <button class="lang-button" onclick="changeLanguage('es')">
        <img src="https://upload.wikimedia.org/wikipedia/commons/f/ff/Bandera_de_Espa%C3%B1a_%28sin_escudo%29.svg"
             alt="Español" title="Español" style="height: 15px"/>
    </button>
    <button class="lang-button" onclick="changeLanguage('en')">
        <img src="https://upload.wikimedia.org/wikipedia/commons/0/0b/English_language.svg"
             alt="English" title="English" style="height: 15px"
        />
    </button>
    <input type="text" id="acestream-link-input" placeholder="Insert Acestream link here"/>
    <button id="load-button">Load</button>
</div>
<div id="links-list"></div>
<script>
    const BASE_STREAM_URL = "http://127.0.0.1:6878/ace/manifest.m3u8?id=";
    const ACESTREAM_PREFIX = "acestream://";
    const player = videojs("video");

    // Carga inicial del video
    function initialLoad(playerId) {
        document.title += `[${playerId.substr(0, 7)}]`;
        player.src({
            src: BASE_STREAM_URL + playerId,
            type: "application/x-mpegURL",
        });
        player.play();
    }

    // Carga del stream de AceStream
    function loadAceStream(link) {
        const playerId = link.replace(ACESTREAM_PREFIX, '');
        if (playerId.length > 1) {
            document.title = `Ace Link [${playerId.substr(0, 7)}]`;
            player.src({
                src: BASE_STREAM_URL + playerId,
                type: 'application/x-mpegURL',
            });
            player.play();
        } else {
            alert('Please insert a valid Acestream link.');
        }
    }

    // Mostrar/ocultar input de Acestream
    function toggleAcestreamInput() {
        const inputDiv = document.getElementById('acestream-link');
        const icon = document.getElementById('toggle-icon');
        inputDiv.style.display = inputDiv.style.display === 'none' ? 'flex' : 'none';
        icon.className = inputDiv.style.display === 'none' ? 'fas fa-eye' : 'fas fa-eye-slash';
    }

    // Cambiar idioma de la página

    function changeLanguage(lang) {
        const acestreamLinkInput = document.getElementById('acestream-link-input');
        acestreamLinkInput.placeholder = lang === 'es' ? 'Insertar aquí el enlace Acestream' : 'Insert Acestream link here';
        const loadButton = document.getElementById('load-button');
        loadButton.innerText = lang === 'es' ? 'Cargar' : 'Load';
    }

    initialLoad("{player_id}");

    document.getElementById('toggle-view').addEventListener('click', toggleAcestreamInput);

    document.getElementById('load-button').addEventListener('click', function () {
        const acestreamLink = document.getElementById('acestream-link-input').value;
        loadAceStream(acestreamLink);
    });

    // Manejar el contenido obtenido
    fetch('https://corsproxy.io/?https://hackmd.io/@67QuUe0VRy-nPCNoJwtsgQ/plan-d')
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const docDiv = doc.querySelector('#doc');
            if (docDiv) {
                const docHtml = docDiv.innerHTML;
                const contentRegex = /---\s*##([\s\S]*?)&lt;style&gt;/;
                const match = docHtml.match(contentRegex);
                if (match && match[1]) {
                    const desiredContent = match[1].trim();
                    processAndDisplayContent(desiredContent);
                } else {
                    console.error('The pattern was not found in the HTML content');
                }
            } else {
                console.error('docDiv is null or does not contain any content');
            }
        })
        .catch(error => {
            console.error('Error fetching the Markdown content:', error);
        });

    // Procesar contenido obtenido
    function postProcessContent(htmlContent) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlContent, 'text/html');
        const allNameWithLinks = doc.querySelectorAll('.name-with-links');
        allNameWithLinks.forEach((div, index) => {
            if (div.querySelector('.name h3').textContent.trim() === '720p' && index > 0) {
                const previousDiv = allNameWithLinks[index - 1];
                const nameDiv = div.querySelector('.name');
                previousDiv.appendChild(nameDiv);
                const linksDiv = div.querySelector('.links');
                previousDiv.appendChild(linksDiv);
                div.remove();
            }
        });
        return doc.body.innerHTML;
    }

    // Procesar y mostrar el contenido obtenido
    function processAndDisplayContent(content) {
        const titleRegex = /==\*\*(.*?)\*\*==\s*([\s\S]*?)(?=(==\*\*|$))/g;
        let match;
        let htmlContent = '';
        while ((match = titleRegex.exec(content)) !== null) {
            const title = match[1];
            const body = match[2];
            let columnContent = `<div class="title"><h2>${title}</h2></div>`;
            const nameAndLinkRegex = /\*\*(.*?)\*\*\s*(?:\[:arrow_forward:\]\((acestream:\/\/.*?)\))+/g;
            let nameMatch;
            while ((nameMatch = nameAndLinkRegex.exec(body)) !== null) {
                const name = nameMatch[1];
                const links = nameMatch[0];
                columnContent += `<div class="name-with-links">`;
                columnContent += `<div class="name"><h3>${name}</h3></div>`;
                columnContent += `<div class="links">`;
                const linkRegex = /\[:arrow_forward:\]\((acestream:\/\/.*?)\)/g;
                let linkMatch;
                while ((linkMatch = linkRegex.exec(links)) !== null) {
                    const link = linkMatch[1];
                    columnContent += `<a href="${link}" class="link-button"><i class="fa-solid fa-play"></i></a>`;
                }
                columnContent += `</div>`;
                columnContent += `</div>`;
            }
            htmlContent += `<div class="column">${columnContent}</div>`;
        }
        let finalHtmlContent = postProcessContent(htmlContent);
        document.getElementById('links-list').innerHTML = finalHtmlContent;
        const linksList = document.getElementById('links-list');
        const links = linksList.querySelectorAll('a');
        links.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const acestreamLink = link.getAttribute('href');
                loadAceStream(acestreamLink);
            });
        });
    }
</script>
</body>
</html>
